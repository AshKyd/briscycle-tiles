events {}
http {
    include       mime.types;
    default_type  application/octet-stream;
    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        # Standard CORS headers for all requests
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        location / {
            try_files $uri $uri/ =404;
        }
        # 1. Tiles Handling: Only rewrite .pbf to .pbf.br for tiles in seqtiles/
        # This prevents breaking fonts or other assets that aren't compressed.
        location ~* /seqtiles/.*\.pbf$ {
            rewrite ^(.*)$ $1.br last;
        }
        # 2. Serve .pbf.br files (either requested directly or via the rewrite above)
        location ~* \.pbf\.br$ {
            # Associate .br extension with protobuf in this scope
            types {
                application/x-protobuf br;
            }
            default_type application/x-protobuf;
            add_header Content-Encoding br;
            # We must repeat CORS headers here because add_header overrides the server-level ones
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        }
        # 3. Handle standard .pbf files (like fonts) that are not compressed
        location ~* \.pbf$ {
            default_type application/x-protobuf;
            # Repeat CORS headers here too
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        }
        # Fonts handling
        location /fonts/ {
            # Ensure folder-level requests are handled, headers are inherited from server block
            # unless we add specific ones here (then we must repeat CORS).
            try_files $uri $uri/ =404;
        }
    }
}